<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>221 BEATS | Smart Link Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0b0e14;
            --card: #161b22;
            --text: #f0f6fc;
            --text-dim: #8b949e;
            --accent: #ff4757;
            --theme-color: #00d2ff;
            --theme-color-rgb: 0, 210, 255;
            --pulse-rgb: 0, 210, 255; 
            --pulse-opacity: 0.5;
            --gradient: linear-gradient(135deg, #ff4757, var(--theme-color));
        }

        * { box-sizing: border-box; font-family: 'Inter', sans-serif; transition: all 0.3s ease; }
        body { background-color: var(--bg); color: var(--text); margin: 0; padding: 0; overflow-x: hidden; }
        .app-container { max-width: 480px; margin: 0 auto; padding: 30px 20px; }

        .header { text-align: center; margin-bottom: 35px; }
        .header h1 { font-size: 2.4rem; font-weight: 900; letter-spacing: -1px; margin: 0; }
        .header h1 span { background: var(--gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        .section-label { font-size: 0.8rem; font-weight: 700; color: var(--text-dim); margin: 25px 0 12px; text-transform: uppercase; letter-spacing: 1.5px; display: block; }

        .input-group { 
            background: var(--card); padding: 12px 15px; border-radius: 15px; margin-top: 10px;
            display: flex; align-items: center; gap: 15px; border: 1px solid #30363d;
            position: relative; /* Important pour le fix */
        }
        
        .input-field { 
            flex: 1; 
            background: transparent !important; /* Force la transparence */
            border: none; 
            color: white; 
            outline: none; 
            font-size: 0.95rem; 
            width: 100%;
        }

        /* --- FIX FOND BLANC (AUTOFILL/PASTE) --- */
        /* Ceci force le navigateur à utiliser la couleur de la carte au lieu du blanc */
        input:-webkit-autofill,
        input:-webkit-autofill:hover, 
        input:-webkit-autofill:focus, 
        input:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0 30px var(--card) inset !important;
            -webkit-text-fill-color: white !important;
            transition: background-color 5000s ease-in-out 0s;
            caret-color: white;
        }

        .preset-container { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
        .preset-btn { width: 35px; height: 35px; border-radius: 50%; border: 2px solid #30363d; cursor: pointer; transition: 0.2s; }
        .preset-btn:hover { transform: scale(1.2); }

        .color-picker-wrapper { display: flex; align-items: center; gap: 10px; width: 100%; }
        input[type="color"] { border: none; width: 30px; height: 30px; border-radius: 5px; cursor: pointer; background: none; }
        input[type="range"] { flex: 1; cursor: pointer; accent-color: var(--theme-color); }

        .test-btn-wrapper { padding: 20px; text-align: center; background: rgba(0,0,0,0.2); border-radius: 15px; margin-top: 10px; border: 1px dashed #30363d; }
        .preview-thumb { width: 100%; aspect-ratio: 1/1; border-radius: 15px; object-fit: cover; margin-top: 10px; display: none; border: 1px solid var(--theme-color); }

        #customAlert {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px);
            background: #ff4757; color: white; padding: 15px 25px; border-radius: 12px;
            font-weight: 700; z-index: 1000; box-shadow: 0 10px 30px rgba(255, 71, 87, 0.4);
            transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #customAlert.show { transform: translateX(-50%) translateY(0); }

        .btn-main { 
            width: 100%; padding: 20px; border-radius: 18px; border: none; 
            background: var(--gradient); color: white; font-weight: 900; 
            margin-top: 40px; cursor: pointer; text-transform: uppercase; font-size: 1.1rem;
            box-shadow: 0 8px 20px rgba(var(--theme-color-rgb), 0.3);
        }

        /* --- PREVIEW STYLE --- */
        #previewSection { display: none; min-height: 100vh; position: relative; padding: 40px 20px 100px; text-align: center; animation: fadeIn 0.5s ease-out; max-width: 480px; margin: 0 auto; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        #bgBlur {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-size: cover; background-position: center;
            filter: blur(50px) brightness(0.3); z-index: -1; transform: scale(1.1);
        }

        .cover-art { 
            width: 100%; aspect-ratio: 1/1; border-radius: 20px; 
            object-fit: cover; margin-bottom: 25px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.6);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .track-title { font-size: 2rem; font-weight: 900; margin: 0; line-height: 1.2; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .artist-name { color: var(--theme-color); font-size: 1.2rem; font-weight: 700; margin: 8px 0 30px; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }

        @keyframes pulse-border {
            0% { box-shadow: 0 0 0 0 rgba(var(--pulse-rgb), var(--pulse-opacity)); }
            70% { box-shadow: 0 0 0 12px rgba(var(--pulse-rgb), 0); }
            100% { box-shadow: 0 0 0 0 rgba(var(--pulse-rgb), 0); }
        }

        .links-container { display: flex; flex-direction: column; gap: 12px; }
        .smart-link-card {
            background: rgba(22, 27, 34, 0.85); backdrop-filter: blur(10px); 
            border: 1px solid rgba(var(--pulse-rgb), 0.5);
            padding: 15px 20px; border-radius: 14px; text-decoration: none; color: white;
            display: flex; align-items: center; justify-content: space-between;
            animation: pulse-border 2s infinite;
        }
        .smart-link-card:hover { transform: translateY(-2px); filter: brightness(1.1); }
        .smart-link-card i { font-size: 1.6rem; width: 35px; }
        .platform-name { flex: 1; text-align: left; font-weight: 700; margin-left: 10px; font-size: 0.95rem; }
        .play-tag { 
            font-size: 0.65rem; font-weight: 800; padding: 6px 14px; 
            border-radius: 6px; border: 1px solid var(--theme-color); color: var(--theme-color);
            text-transform: uppercase; letter-spacing: 1px;
        }

        .copy-link-btn {
            background: rgba(0,0,0, 0.6); border: 1px solid var(--theme-color); color: var(--theme-color);
            padding: 12px 25px; border-radius: 50px; font-size: 0.75rem; font-weight: 800;
            cursor: pointer; margin-bottom: 30px; display: inline-flex; align-items: center; gap: 8px; text-transform: uppercase;
            backdrop-filter: blur(5px);
        }
        .copy-link-btn:hover { background: var(--theme-color); color: black; }

        .footer-brand { position: absolute; bottom: 30px; left: 0; width: 100%; text-align: center; font-size: 0.8rem; color: var(--text-dim); text-decoration: none; }
        .footer-brand span { font-weight: 900; background: var(--gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .edit-btn { 
            position: fixed; top: 20px; right: 20px; 
            background: rgba(22, 27, 34, 0.8); color: white; 
            width: 45px; height: 45px; border-radius: 50%; 
            display: flex; justify-content: center; align-items: center; 
            cursor: pointer; z-index: 100; border: 1px solid rgba(255,255,255,0.1); 
        }
    </style>
</head>
<body>

    <div id="customAlert">Attention : Titre et Pochette requis !</div>

    <div class="app-container" id="editSection">
        <div class="header"><h1> <span>SMART LINK</span></h1></div>
        
        <span class="section-label">Visuel de la sortie</span>
        <div class="input-group">
            <i class="fas fa-image"></i>
            <input type="url" id="trackCover" class="input-field" placeholder="Lien URL de la pochette" oninput="updateThumb(this.value)">
        </div>
        <img id="thumbPreview" class="preview-thumb">

        <span class="section-label">Détails</span>
        <div class="input-group"><i class="fas fa-music"></i><input type="text" id="trackTitle" class="input-field" placeholder="Titre du son"></div>
        <div class="input-group"><i class="fas fa-user"></i><input type="text" id="trackArtist" class="input-field" placeholder="Nom de l'artiste"></div>

        <span class="section-label">Style Néon (Ombre)</span>
        <div class="input-group" style="flex-direction: column; align-items: flex-start;">
            <div class="preset-container">
                <div class="preset-btn" style="background:#00d2ff" onclick="setPreset('#00d2ff')"></div>
                <div class="preset-btn" style="background:#ff4757" onclick="setPreset('#ff4757')"></div>
                <div class="preset-btn" style="background:#1DB954" onclick="setPreset('#1DB954')"></div>
                <div class="preset-btn" style="background:#ff5500" onclick="setPreset('#ff5500')"></div>
                <input type="color" id="shadowColor" value="#00d2ff" oninput="liveUpdate()">
            </div>
            <div class="color-picker-wrapper" style="margin-top: 15px;">
                <i class="fas fa-sun"></i>
                <span style="font-size: 0.8rem;">Intensité:</span>
                <input type="range" id="shadowIntensity" min="0.1" max="1" step="0.1" value="0.5" oninput="liveUpdate()">
            </div>
        </div>

        <div class="test-btn-wrapper">
            <div class="smart-link-card" id="testBtn" style="margin: 0; pointer-events: none;">
                <i class="fab fa-soundcloud" style="color:#ff5500"></i>
                <span class="platform-name">Aperçu du néon</span>
                <span class="play-tag">ÉCOUTER</span>
            </div>
        </div>

        <span class="section-label">Liens de streaming</span>
        <div class="input-group"><i class="fab fa-youtube" style="color:#ff0000"></i><input type="url" id="linkYT" class="input-field" placeholder="Lien YouTube"></div>
        <div class="input-group"><i class="fab fa-spotify" style="color:#1DB954"></i><input type="url" id="linkSP" class="input-field" placeholder="Lien Spotify"></div>
        <div class="input-group"><i class="fab fa-soundcloud" style="color:#ff5500"></i><input type="url" id="linkSC" class="input-field" placeholder="Lien SoundCloud"></div>
        <div class="input-group"><i class="fab fa-tiktok" style="color:#ffffff"></i><input type="url" id="linkTK" class="input-field" placeholder="Lien TikTok"></div>
        <div class="input-group"><i class="fas fa-headphones" style="color:#ffa200"></i><input type="url" id="linkAM" class="input-field" placeholder="Lien Audiomack"></div>
        <div class="input-group"><i class="fas fa-play-circle" style="color:#e11212"></i><input type="url" id="linkBP" class="input-field" placeholder="Lien Boomplay"></div>

        <button class="btn-main" onclick="buildSmartLink()">Générer ma page</button>
    </div>

    <div id="previewSection">
        <div id="bgBlur"></div>
        <div class="edit-btn" id="editBtn" onclick="goBack()"><i class="fas fa-pen"></i></div>
        
        <img id="resCover" class="cover-art" src="">
        <h2 id="resTitle" class="track-title"></h2>
        <p id="resArtist" class="artist-name"></p>
        
        <button class="copy-link-btn" id="copyBtn" onclick="copySmartLink()">
            <i class="fas fa-link"></i> <span id="copyTxt">Copier mon lien</span>
        </button>

        <div id="resLinks" class="links-container"></div>
        
        <a href="https://od.lk/d/OTRfMTQwNTc5NDU5Xw/221beats.apk" class="footer-brand">Powered by <span>221 BEATS</span></a>
    </div>

    <script>
        const platforms = {
            yt: { name: "YouTube", icon: "fab fa-youtube", color: "#FF0000" },
            sp: { name: "Spotify", icon: "fab fa-spotify", color: "#1DB954" },
            sc: { name: "SoundCloud", icon: "fab fa-soundcloud", color: "#ff5500" },
            tk: { name: "TikTok", icon: "fab fa-tiktok", color: "#ffffff" },
            am: { name: "Audiomack", icon: "fas fa-headphones", color: "#FFA200" },
            bp: { name: "Boomplay", icon: "fas fa-play-circle", color: "#e11212" }
        };

        let currentData = {}; // Stocke les données actuelles pour éviter les erreurs de copie

        // Encodage/Décodage Base64 compatible Unicode (emojis, accents)
        function b64EncodeUnicode(str) {
            return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,
                function toSolidBytes(match, p1) {
                    return String.fromCharCode('0x' + p1);
            }));
        }

        function b64DecodeUnicode(str) {
            return decodeURIComponent(atob(str).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
        }

        function sanitize(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function showError() {
            const alert = document.getElementById('customAlert');
            alert.classList.add('show');
            setTimeout(() => alert.classList.remove('show'), 3000);
        }

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : "0, 210, 255";
        }

        function setPreset(color) {
            document.getElementById('shadowColor').value = color;
            liveUpdate();
        }

        function liveUpdate() {
            const color = document.getElementById('shadowColor').value;
            const intensity = document.getElementById('shadowIntensity').value;
            const rgb = hexToRgb(color);
            document.documentElement.style.setProperty('--theme-color', color);
            document.documentElement.style.setProperty('--theme-color-rgb', rgb);
            document.documentElement.style.setProperty('--pulse-rgb', rgb);
            document.documentElement.style.setProperty('--pulse-opacity', intensity);
        }

        function updateThumb(url) {
            const thumb = document.getElementById('thumbPreview');
            if(url.length > 10) { thumb.src = url; thumb.style.display = 'block'; }
            else { thumb.style.display = 'none'; }
        }

        window.onload = () => {
            liveUpdate();
            const params = new URLSearchParams(window.location.search);
            if(params.has('s')) {
                try {
                    // Mode lecture seule (lien partagé)
                    const jsonStr = b64DecodeUnicode(params.get('s'));
                    const data = JSON.parse(jsonStr);
                    currentData = data; // Sauvegarde
                    renderSmartLink(data);
                    
                    // En mode lecture, on cache les boutons d'édition et de copie
                    document.getElementById('editBtn').style.display = 'none';
                    document.getElementById('copyBtn').style.display = 'none';
                } catch(e) { 
                    console.error("Erreur de décodage URL:", e); 
                }
            }
        };

        function buildSmartLink() {
            const title = document.getElementById('trackTitle').value.trim();
            const cover = document.getElementById('trackCover').value.trim();
            
            if(!title || !cover) { showError(); return; }

            // Construction de l'objet de données propre
            currentData = {
                t: title,
                a: document.getElementById('trackArtist').value || "Artiste",
                c: cover,
                sc: document.getElementById('shadowColor').value,
                si: document.getElementById('shadowIntensity').value,
                l: {
                    yt: document.getElementById('linkYT').value.trim(),
                    sp: document.getElementById('linkSP').value.trim(),
                    sc: document.getElementById('linkSC').value.trim(),
                    tk: document.getElementById('linkTK').value.trim(),
                    am: document.getElementById('linkAM').value.trim(),
                    bp: document.getElementById('linkBP').value.trim()
                }
            };

            renderSmartLink(currentData);
            
            // En mode création, on affiche le bouton retour
            document.getElementById('editBtn').style.display = 'flex';
            document.getElementById('copyBtn').style.display = 'inline-flex';
            window.scrollTo(0,0);
        }

        function renderSmartLink(data) {
            document.getElementById('resTitle').textContent = data.t;
            document.getElementById('resArtist').textContent = data.a;
            document.getElementById('resCover').src = data.c;
            document.getElementById('bgBlur').style.backgroundImage = `url('${data.c}')`;
            
            const rgbColor = hexToRgb(data.sc || "#00d2ff");
            document.documentElement.style.setProperty('--theme-color', data.sc);
            document.documentElement.style.setProperty('--pulse-rgb', rgbColor);
            document.documentElement.style.setProperty('--pulse-opacity', data.si || 0.5);

            const container = document.getElementById('resLinks');
            container.innerHTML = "";

            Object.keys(data.l).forEach(key => {
                if(data.l[key] && platforms[key]) {
                    let url = data.l[key];
                    if(!url.startsWith('http')) url = 'https://' + url;
                    
                    // Création sécurisée des éléments HTML
                    const link = document.createElement('a');
                    link.href = url;
                    link.target = "_blank";
                    link.className = "smart-link-card";
                    
                    link.innerHTML = `
                        <i class="${platforms[key].icon}" style="color:${platforms[key].color}"></i>
                        <span class="platform-name">${platforms[key].name}</span>
                        <span class="play-tag">Écouter</span>
                    `;
                    container.appendChild(link);
                }
            });

            document.getElementById('editSection').style.display = 'none';
            document.getElementById('previewSection').style.display = 'block';
        }

        function copySmartLink() {
            if(!currentData.t) return;

            const jsonStr = JSON.stringify(currentData);
            const encoded = b64EncodeUnicode(jsonStr);
            
            // On retire les paramètres existants avant d'ajouter le nouveau
            const baseUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
            const fullLink = baseUrl + "?s=" + encoded;
            
            navigator.clipboard.writeText(fullLink).then(() => {
                const btnTxt = document.getElementById('copyTxt');
                const originalTxt = btnTxt.innerText;
                btnTxt.innerText = "Lien copié !";
                document.getElementById('copyBtn').style.background = "#00d2ff";
                document.getElementById('copyBtn').style.color = "#000";

                setTimeout(() => { 
                    btnTxt.innerText = "Copier mon lien"; 
                    document.getElementById('copyBtn').style.background = "";
                    document.getElementById('copyBtn').style.color = "";
                }, 2000);
            }).catch(err => {
                console.error('Erreur copie', err);
                alert("Impossible de copier automatiquement. Le lien est dans la console.");
            });
        }

        function goBack() { 
            document.getElementById('editSection').style.display = 'block'; 
            document.getElementById('previewSection').style.display = 'none'; 
            window.scrollTo(0,0);
        }
    </script>
</body>
                    </html>
